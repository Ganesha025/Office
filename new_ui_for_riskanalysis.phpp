<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KASC Risk Predictions | Dashboard</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <style>
        /* --- Global Styles & Font --- */
        :root {
            --primary-color: #4318FF;      /* Vibrant Blue */
            --secondary-color: #6AD2FF;    /* Light Blue */
            --text-main: #2B3674;          /* Dark Navy */
            --text-light: #A3AED0;         /* Grey */
            --bg-body: #F4F7FE;            /* Light Greyish Blue */
            --card-bg: #FFFFFF;
            --success: #05CD99;
            --warning: #FFCE20;
            --danger: #EE5D50;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #CBD5E0;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #A0AEC0;
        }

        /* --- Components --- */
        .card {
            background-color: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 18px 40px rgba(112, 144, 176, 0.12);
            padding: 20px;
            transition: transform 0.2s ease;
            height: 100%;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }

        .text-brand {
            color: var(--primary-color);
        }
        .bg-brand {
            background-color: var(--primary-color);
        }

        /* --- Header --- */
        header {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #E0E5F2;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        /* --- Table Styling --- */
        #riskTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: transparent;
        }

        #riskTable thead th {
            background: #f0f0f0;
            color: black;
            font-weight: 500;
            font-size: 14px;
            padding: 12px 10px;
            border-bottom: 1px solid #E0E5F2;
            text-align: left;
        }

        #riskTable tbody td {
            padding: 16px 10px;
            border-bottom: 1px solid #E0E5F2;
            color: var(--text-main);
            font-size: 14px;
            background: transparent;
            vertical-align: middle;
        }
        
        #riskTable tbody tr:hover td {
            background-color: #F8F9FC;
        }

        /* Risk Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 60px;
        }
        .badge-low { background: rgba(5, 205, 153, 0.1); color: var(--success); }
        .badge-medium { background: rgba(255, 206, 32, 0.30); color: var(--warning); }
        .badge-high { background: rgba(238, 93, 80, 0.1); color: var(--danger); }

        /* DataTable Overrides */
        .dataTables_filter input {
            border: 1px solid #E0E5F2;
            border-radius: 10px;
            padding: 8px 12px;
            color: var(--text-main);
            outline: none;
            margin-left: 10px;
        }
        .dataTables_length select {
            border: 1px solid #E0E5F2;
            border-radius: 8px;
            padding: 5px 10px;
            color: var(--text-main);
            outline: none;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 6px 12px !important;
            border-radius: 8px !important;
            border: none !important;
            background: transparent !important;
            color: var(--text-main) !important;
            font-weight: 600;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: var(--primary-color) !important;
            color: white !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #F4F7FE !important;
        }

        /* --- Form Elements --- */
        select, input {
            font-family: 'Poppins', sans-serif;
        }
        
        /* --- Stats Card Special Styling --- */
        .stats-icon-box {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }

        /* --- Modal Animation --- */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="h-20">
        <div class="max-w-full mx-auto px-6 h-full flex items-center justify-between">
            <!-- Logo & Nav -->
            <div class="flex items-center space-x-10">
                <div class="flex items-center gap-2">
                    <img src="https://portal.kongunaducollege.ac.in//uploads/banner/logo.png" alt="Logo" class="h-10 w-auto object-contain">
                    <span class="text-2xl font-bold text-[#2B3674] tracking-wide">KASC</span>
                </div>
            </div>

            <!-- Right Actions -->
            <div class="flex items-center space-x-6">
                <!-- Search -->
                <div class="hidden sm:flex items-center bg-white border border-[#E0E5F2] rounded-full px-4 h-10 shadow-sm">
                    <span class="material-icons text-[#A3AED0] text-[18px]">search</span>
                    <input type="text" placeholder="Search..." class="ml-2 w-40 bg-transparent outline-none text-sm text-[#2B3674] placeholder-[#A3AED0]">
                </div>

                <!-- Icons -->
                <button class="relative p-2 rounded-full hover:bg-[#F4F7FE] transition">
                    <span class="material-icons text-[#A3AED0]">dark_mode</span>
                </button>
                <button class="relative p-2 rounded-full hover:bg-[#F4F7FE] transition">
                    <span class="material-icons text-[#A3AED0]">notifications</span>
                    <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                </button>

                <!-- Profile Dropdown -->
                <div class="relative group">
                    <button id="accountBtn" class="flex items-center gap-3 focus:outline-none">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm font-bold text-[#2B3674] leading-none">Matt Dickson</p>
                            <p class="text-xs text-[#A3AED0] mt-1">Admin</p>
                        </div>
                        <img src="https://ui-avatars.com/api/?name=Matt+Dickson&background=4318FF&color=fff" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
                    </button>
                    <!-- Dropdown -->
                    <div id="accountDropdown" class="hidden absolute right-0 mt-3 w-48 bg-white rounded-20 shadow-xl border border-[#E0E5F2] py-2 z-50">
                        <a href="#" class="block px-4 py-2 text-sm text-[#2B3674] hover:bg-[#F4F7FE]">Profile</a>
                        <a href="#" class="block px-4 py-2 text-sm text-[#2B3674] hover:bg-[#F4F7FE]">Settings</a>
                        <div class="h-px bg-[#E0E5F2] my-1"></div>
                        <a href="#" class="block px-4 py-2 text-sm text-[#EE5D50] hover:bg-[#FFF5F5]">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="px-6 py-6 max-w-full">
        
<!-- COMBINED HEADER & CARDS CONTAINER -->
<div class="rounded-[20px] p-5 mb-6 shadow-sm bg-[#b0e2ff]">

    <div class="flex flex-col xl:flex-row items-center justify-between gap-4">

        <!-- LEFT: Greeting -->
        <div class="flex-shrink-0 text-center xl:text-left">
            <h2 class="text-2xl font-bold text-[#2B3674]">Hello, Principal ðŸ‘‹</h2>
            <p class="text-sm text-[#2B3674] font-medium mt-2 max-w-[260px]">
                Hereâ€™s an overview of todayâ€™s student risk analytics
            </p>
        </div>

        <!-- CENTER: Compact Stats Cards -->
        <div class="flex-1 grid grid-cols-2 lg:grid-cols-4 gap-3">

            <!-- Card 1 -->
            <div class="card relative flex flex-col items-start justify-center px-3 py-4 min-h-[100px] max-w-[250px] overflow-hidden">

                <div class="stats-icon-box absolute top-3 right-3 bg-orange-100"
                     style="width:38px;height:38px;font-size:20px;color:#F97316;">
                    <span class="material-icons">people</span>
                </div>

                <p class="text-[11px] text-[#F97316] font-semibold uppercase mt-2">Total Students</p>
                <h4 class="text-xl font-bold text-[#2B3674]" id="totalStudentsVal">1,242</h4>

                <!-- Light Blue Half Circle -->
                <div class="absolute -bottom-6 -right-6 w-16 h-16 bg-[#D6ECFF] rounded-full"></div>
            </div>

            <!-- Card 2 -->
            <div class="card relative flex flex-col items-start justify-center px-3 py-4 min-h-[100px] max-w-[250px] overflow-hidden">

                <div class="stats-icon-box absolute top-3 right-3 bg-orange-100"
                     style="width:38px;height:38px;font-size:20px;color:#F97316;">
                    <span class="material-icons">warning</span>
                </div>

                <p class="text-[11px] text-[#F97316] font-semibold uppercase mt-2">High Risk</p>
                <h4 class="text-xl font-bold text-[#2B3674]" id="highRiskVal">32</h4>

                <div class="absolute -bottom-6 -right-6 w-16 h-16 bg-[#D6ECFF] rounded-full"></div>
            </div>

            <!-- Card 3 -->
            <div class="card relative flex flex-col items-start justify-center px-3 py-4 min-h-[100px] max-w-[250px] overflow-hidden">

                <div class="stats-icon-box absolute top-3 right-3 bg-orange-100"
                     style="width:38px;height:38px;font-size:20px;color:#F97316;">
                    <span class="material-icons">error_outline</span>
                </div>

                <p class="text-[11px] text-[#F97316] font-semibold uppercase mt-2">Medium Risk</p>
                <h4 class="text-xl font-bold text-[#2B3674]" id="medRiskVal">78</h4>

                <div class="absolute -bottom-6 -right-6 w-16 h-16 bg-[#D6ECFF] rounded-full"></div>
            </div>

            <!-- Card 4 -->
            <div class="card relative flex flex-col items-start justify-center px-3 py-4 min-h-[100px] max-w-[250px] overflow-hidden">

                <div class="stats-icon-box absolute top-3 right-3 bg-orange-100"
                     style="width:38px;height:38px;font-size:20px;color:#F97316;">
                    <span class="material-icons">domain</span>
                </div>

                <p class="text-[11px] text-[#F97316] font-semibold uppercase mt-2">Top Dept</p>
                <h4 class="text-lg font-bold text-[#2B3674]" id="topDeptVal">CSE</h4>

                <div class="absolute -bottom-6 -right-6 w-16 h-16 bg-[#D6ECFF] rounded-full"></div>
            </div>

        </div>

        <!-- RIGHT: Add Student Button -->
        <div class="flex-shrink-0">
            <button id="openModalBtn"
                class="bg-[#f97316] hover:bg-[#D65A0F] text-white px-5 py-3 
                       rounded-xl font-semibold shadow-lg shadow-[#D65A0F]/30 
                       transition flex items-center gap-2 whitespace-nowrap">
                <span class="material-icons text-[20px]">add</span>
                Add Student
            </button>
        </div>

    </div>
</div>



        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            
            <!-- Pie Chart -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-[#000000]">Risk Distribution</h3>
                    
                </div>
                <div id="myPieChart" class="w-full h-64"></div>
            </div>

            <!-- Bar Chart 1 -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-[#000000]">High Risk by Dept</h3>
                    
                </div>
                <div class="w-full h-64 relative">
                    <canvas id="deptBarChart"></canvas>
                </div>
            </div>

            <!-- Bar Chart 2 -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-[#000000]">Incident Analysis</h3>
                    
                </div>
                <div class="w-full h-64 relative">
                    <canvas id="incidentChart"></canvas>
                </div>
            </div>
        </div>

            <!-- Fee Payment & Student Details Container -->
<div class="card p-6 mb-6">

    <!-- Header -->
    <h3 class="text-lg font-bold text-[#000000] mb-6">
        Department Fee Payment Status
    </h3>

    <!-- Chart + List Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- LEFT: Chart (2 columns) -->
        <div class="lg:col-span-2 border-r border-[#cccccc] pr-4">
            <div id="deptChart" class="w-full h-[450px]"></div>
        </div>

        <!-- RIGHT: Student List (1 column) -->
        <div class="flex flex-col">

            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-lg font-bold text-[#000000]" id="studentCardTitle">
                        Department List
                    </h3>
                    <p class="text-xs text-[#A3AED0] mt-1" id="studentCardSub">
                        Fee Status
                    </p>
                </div>

                <div class="w-8 h-8 rounded-full bg-[#F4F7FE] flex items-center justify-center text-[#000000]">
                    <span class="material-icons text-[18px]">receipt_long</span>
                </div>
            </div>

            <div id="studentList" class="flex-1 overflow-y-auto pr-2 space-y-3">
                <!-- Dynamic Content -->
            </div>
        </div>

    </div>
</div>



        <!-- Data Table -->
        <div class="card p-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h3 class="text-lg font-bold text-[#000000]">Overall Risk Analysis</h3>
                <div class="flex items-center gap-3">
                    <label class="text-sm text-[#A3AED0]">Filter Dept:</label>
                    <select id="departments" class="bg-[#F4F7FE] border-none rounded-lg px-3 py-2 text-sm text-[#2B3674] font-medium outline-none cursor-pointer">
                        <option value="">All Departments</option>
                        <option value="CSE">Computer Science</option>
                        <option value="ECE">Electronics</option>
                        <option value="MECH">Mechanical</option>
                        <option value="CIVIL">Civil</option>
                    </select>
                </div>
            </div>
            
            <div class="overflow-x-hidden">
                <table id="riskTable" class="w-full">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Student Name</th>
                            <th>Department</th>
                            <th>Attendance</th>
                            <th>Internal Marks</th>
                            <th>Fee Due</th>
                            <th>Incidents</th>
                            <th>Risk Score</th>
                            <th>Risk Level</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Populated via JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Modal -->
    <div id="addStudentModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[100] backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[20px] shadow-2xl w-full max-w-lg p-8 relative transform scale-95 transition-transform duration-300">
            <button id="closeAddStudentModal" class="absolute top-5 right-5 text-[#A3AED0] hover:text-[#2B3674]">
                <span class="material-icons text-2xl">close</span>
            </button>
            <h3 class="text-2xl font-bold text-[#2B3674] mb-6">Add New Student</h3>
            
            <form id="formAddStudent" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-[#2B3674] mb-1">Student Name</label>
                    <input type="text" id="inputStudentName" class="w-full bg-[#F4F7FE] border border-transparent focus:bg-white focus:border-[#4318FF] rounded-xl px-4 py-3 outline-none transition" placeholder="John Doe">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-[#2B3674] mb-1">Department</label>
                    <select id="department" class="w-full bg-[#F4F7FE] border border-transparent focus:bg-white focus:border-[#4318FF] rounded-xl px-4 py-3 outline-none transition">
                        <option value="">--- Select ---</option>
                        <option value="CSE" data-fee="45000">Computer Science</option>
                        <option value="ECE" data-fee="42000">Electronics</option>
                        <option value="MECH" data-fee="35000">Mechanical</option>
                    </select>
                    <div id="deptFeeDisplay" class="text-xs text-[#4318FF] mt-2 font-medium"></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-[#2B3674] mb-1">Incidents</label>
                        <input type="number" id="inputIncidents" class="w-full bg-[#F4F7FE] border border-transparent focus:bg-white focus:border-[#4318FF] rounded-xl px-4 py-3 outline-none transition" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-[#2B3674] mb-1">Internal Marks</label>
                        <input type="number" id="inputInternalMarks" class="w-full bg-[#F4F7FE] border border-transparent focus:bg-white focus:border-[#4318FF] rounded-xl px-4 py-3 outline-none transition" placeholder="0-50">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-[#2B3674] mb-1">Attendance %</label>
                        <input type="number" id="inputAttendance" class="w-full bg-[#F4F7FE] border border-transparent focus:bg-white focus:border-[#4318FF] rounded-xl px-4 py-3 outline-none transition" placeholder="0-100">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-[#2B3674] mb-1">Paid Amount</label>
                        <input type="number" id="paidAmount" class="w-full bg-[#F4F7FE] border border-transparent focus:bg-white focus:border-[#4318FF] rounded-xl px-4 py-3 outline-none transition" placeholder="â‚¹">
                    </div>
                </div>
                
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" id="cancelAddStudentModal" class="px-6 py-2 rounded-xl border border-[#E0E5F2] text-[#2B3674] font-semibold hover:bg-[#F4F7FE] transition">Cancel</button>
                    <button type="submit" id="formSubmitBtn" class="px-6 py-2 rounded-xl bg-[#4318FF] text-white font-semibold shadow-lg shadow-[#4318FF]/40 hover:bg-[#3311DB] transition disabled:opacity-50 disabled:cursor-not-allowed">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 right-6 z-[110] hidden px-6 py-4 rounded-2xl shadow-2xl text-white font-medium transform translate-x-10 transition-all duration-300 flex items-center gap-3">
        <span id="toastIcon" class="material-icons">check_circle</span>
        <span id="toastMsg"></span>
    </div>

    <!-- Scripts -->
    <script>
        /* 
         * MOCK DATA 
         * Replaces PHP variables for the standalone HTML demo
         */
        const lowHighData = [
            { risk_level: 'LOW', 'COUNT(*)': 450 },
            { risk_level: 'MEDIUM', 'COUNT(*)': 78 },
            { risk_level: 'HIGH', 'COUNT(*)': 32 }
        ];

        const incidentAnalysisData = [
            { department_name: 'CSE', total_incidents: 12 },
            { department_name: 'ECE', total_incidents: 8 },
            { department_name: 'MECH', total_incidents: 5 },
            { department_name: 'CIVIL', total_incidents: 2 }
        ];

        const deptBarData = [
            { department_name: 'CSE', total: 15 },
            { department_name: 'ECE', total: 10 },
            { department_name: 'MECH', total: 5 },
            { department_name: 'CIVIL', total: 2 }
        ];

        const stackedBarData = [
            { department_name: 'CSE', paid_count: 120, unpaid_count: 15, department_fees_amount: 45000, unpaid_students: [
                {name: 'Alex R.', amount: 12000}, {name: 'Sarah K.', amount: 5000}, {name: 'Mike T.', amount: 45000}
            ]},
            { department_name: 'ECE', paid_count: 100, unpaid_count: 10, department_fees_amount: 42000, unpaid_students: [
                {name: 'John D.', amount: 42000}, {name: 'Emma W.', amount: 10000}
            ]},
            { department_name: 'MECH', paid_count: 80, unpaid_count: 25, department_fees_amount: 35000, unpaid_students: [
                {name: 'Chris P.', amount: 20000}, {name: 'Pat B.', amount: 35000}
            ]},
            { department_name: 'CIVIL', paid_count: 60, unpaid_count: 5, department_fees_amount: 30000, unpaid_students: []}
        ];

        const tableData = [
            { roll_no: '21CS01', student_name: 'Alex Robinson', department_name: 'CSE', attendance_percentage: 45, avg_internal_marks: 12, fee_due_amount: 45000, incident_count: 4, risk_score: 85, risk_level: 'HIGH' },
            { roll_no: '21CS02', student_name: 'Sarah Connor', department_name: 'CSE', attendance_percentage: 88, avg_internal_marks: 42, fee_due_amount: 0, incident_count: 0, risk_score: 12, risk_level: 'LOW' },
            { roll_no: '21EC03', student_name: 'John Doe', department_name: 'ECE', attendance_percentage: 65, avg_internal_marks: 28, fee_due_amount: 10000, incident_count: 1, risk_score: 55, risk_level: 'MEDIUM' },
            { roll_no: '21ME04', student_name: 'Mike Tyson', department_name: 'MECH', attendance_percentage: 92, avg_internal_marks: 45, fee_due_amount: 0, incident_count: 0, risk_score: 5, risk_level: 'LOW' },
            { roll_no: '21CV05', student_name: 'Jane Smith', department_name: 'CIVIL', attendance_percentage: 72, avg_internal_marks: 30, fee_due_amount: 15000, incident_count: 2, risk_score: 60, risk_level: 'MEDIUM' },
            { roll_no: '21CS06', student_name: 'Will Smith', department_name: 'CSE', attendance_percentage: 40, avg_internal_marks: 10, fee_due_amount: 45000, incident_count: 5, risk_score: 90, risk_level: 'HIGH' }
        ];


        /* --- UI LOGIC & CHARTS --- */
        
        // 1. Dropdown Toggle
        const accountBtn = document.getElementById('accountBtn');
        const accountDropdown = document.getElementById('accountDropdown');
        accountBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            accountDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
            if (!accountBtn.contains(e.target) && !accountDropdown.contains(e.target)) {
                accountDropdown.classList.add('hidden');
            }
        });

        // 2. Toast Notification
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const text = document.getElementById('toastMsg');
            const icon = document.getElementById('toastIcon');
            
            text.textContent = msg;
            toast.className = `fixed top-6 right-6 z-[110] px-6 py-4 rounded-2xl shadow-2xl text-white font-medium transition-all duration-300 flex items-center gap-3 transform translate-x-0`;
            
            if (type === 'success') {
                toast.classList.add('bg-[#05CD99]');
                icon.textContent = 'check_circle';
            } else if (type === 'error') {
                toast.classList.add('bg-[#EE5D50]');
                icon.textContent = 'error';
            } else {
                toast.classList.add('bg-[#FFCE20]');
                icon.textContent = 'warning';
            }

            setTimeout(() => {
                toast.classList.add('translate-x-10', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // 3. Charts Initialization
        
        // Chart A: Incident Analysis (Bar - Chart.js)
        const ctxIncident = document.getElementById('incidentChart').getContext('2d');

new Chart(ctxIncident, {
    type: 'bar',
    data: {
        labels: incidentAnalysisData.map(d => d.department_name),
        datasets: [{
            label: 'Incidents',
            data: incidentAnalysisData.map(d => d.total_incidents),
            backgroundColor: '#f97316',
            borderRadius: 6,
            barThickness: 30
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,

        plugins: {
            legend: { display: true }
        },

        scales: {
            x: {
                grid: { display: false },
                ticks: {
                    font: { family: 'Poppins' }
                },
                title: {
                    display: true,
                    text: 'Departments',          // âœ… X-axis label
                    // color: '#2B3674',
                    font: {
                        family: 'Poppins',
                        size: 14,
                        weight: '400'
                    }
                }
            },
            y: {
                beginAtZero: true,
                grid: { color: '#F4F7FE' },
                ticks: {
                    font: { family: 'Poppins' }
                },
                title: {
                    display: true,
                    text: 'Number of Incidents',  // âœ… Y-axis label
                    // color: '#2B3674',
                    font: {
                        family: 'Poppins',
                        size: 14,
                        weight: '400'
                    }
                }
            }
        }
    }
});

        // Chart B: High Risk by Dept (Bar - Chart.js)
       const ctxDept = document.getElementById('deptBarChart').getContext('2d');

new Chart(ctxDept, {
    type: 'bar',
    data: {
        labels: deptBarData.map(d => d.department_name),
        datasets: [{
            label: 'Students',
            data: deptBarData.map(d => d.total),
            backgroundColor: '#4318FF',
            borderRadius: 6,
            barThickness: 30
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,

        plugins: {
            legend: { display: true }
        },

        scales: {
            x: {
                grid: { display: false },
                ticks: {
                    font: { family: 'Poppins' }
                },
                title: {
                    display: true,
                    text: 'Departments',          // âœ… X-axis label
                    // color: '#2B3674',
                    font: {
                        family: 'Poppins',
                        size: 14,
                        weight: '400'
                    }
                }
            },
            y: {
                beginAtZero: true,
                grid: { color: '#F4F7FE' },
                ticks: {
                    font: { family: 'Poppins' }
                },
                title: {
                    display: true,
                    text: 'Number of Students',   // âœ… Y-axis label
                    // color: '#2B3674',
                    font: {
                        family: 'Poppins',
                        size: 14,
                        weight: '400'
                    }
                }
            }
        }
    }
});

        // Chart C: Risk Distribution (Donut - ApexCharts)
        new ApexCharts(document.querySelector("#myPieChart"), {
            chart: { type: 'donut', height: 260, fontFamily: 'Poppins, sans-serif' },
            series: lowHighData.map(d => d["COUNT(*)"]),
            labels: lowHighData.map(d => d.risk_level + " Risk"),
            colors: ['#05CD99', '#FFCE20', '#EE5D50'],
            plotOptions: { pie: { donut: { size: '75%' } } },
            dataLabels: { enabled: false },
            legend: { position: 'bottom', fontFamily: 'Poppins' },
            stroke: { show: false }
        }).render();

        // Chart D: Fee Payment (Stacked Horizontal Bar - ApexCharts)
        const feeOptions = {
    chart: {
        type: 'bar',
        height: 450,
        stacked: true,
        toolbar: { show: false },
        fontFamily: 'Poppins, sans-serif'
    },

    plotOptions: {
        bar: {
            horizontal: true,
            borderRadius: 4,
            barHeight: 30
        }
    },

    fill: {
        type: 'solid',
        opacity: 1        // ðŸ”´ IMPORTANT
    },

    states: {
        normal: { filter: { type: 'none' } },
        hover:  { filter: { type: 'none' } },
        active: { filter: { type: 'none' } }
    },

    dataLabels: { enabled: false },

    series: [
        { name: 'Paid', data: stackedBarData.map(d => d.paid_count) },
        { name: 'Unpaid', data: stackedBarData.map(d => d.unpaid_count) }
    ],

    colors: ['#05CD99', '#E8610F'], // SAME ORANGE

    xaxis: {
        categories: stackedBarData.map(d => d.department_name),
        labels: { style: { colors: '#A3AED0' } }
    },

    yaxis: {
        labels: { style: { colors: '#2B3674', fontWeight: 600 } }
    },

    grid: { show: false },

    legend: {
        position: 'top',
        horizontalAlign: 'right'
    },

    tooltip: { theme: 'light' }
};

        const deptChart = new ApexCharts(document.querySelector("#deptChart"), feeOptions);
        deptChart.render();

        // Chart E: Data Table (DataTables)
        const table = $('#riskTable').DataTable({
            data: tableData,
            columns: [
                { data: 'roll_no' },
                { data: 'student_name' },
                { data: 'department_name' },
                { 
                    data: 'attendance_percentage',
                    render: function(data) {
                        return `<div class="flex items-center gap-2">
                                    <div class="overflow-hidden">
                                        <div class="h-full bg-[#4318FF]" style="width: ${data}%"></div>
                                    </div>
                                    <span class="text-sm ">${data}%</span>
                                </div>`;
                    }
                },
                { data: 'avg_internal_marks' },
                { 
                    data: 'fee_due_amount',
                    render: data => data > 0 ? `<span class="text-[#EE5D50] font-bold">â‚¹${data.toLocaleString()}</span>` : `<span class="text-[#05CD99] font-bold">Paid</span>`
                },
                { data: 'incident_count' },
                { data: 'risk_score' },
                {
                    data: 'risk_level',
                    render: function(data) {
                        let cls = data === 'LOW' ? 'badge-low' : (data === 'MEDIUM' ? 'badge-medium' : 'badge-high');
                        return `<span class="badge ${cls}">${data}</span>`;
                    }
                }
            ],
            pageLength: 5,
            lengthMenu: [5, 10, 25],
            language: { search: "", searchPlaceholder: "Search..." },
            dom: '<"flex justify-between items-center mb-4"fl>rt<"flex justify-between items-center mt-4"ip>',
            drawCallback: function() { $('.dataTables_filter input').addClass('focus:ring-0'); }
        });

        // Filter Table
        $('#departments').on('change', function() {
            const dept = $(this).val();
            table.column(2).search(dept).draw();
        });


        /* --- INTERACTION LOGIC --- */

        // Show Student Card (Right side of Fee Chart)
        function showStudentCard(dept) {
            const container = document.getElementById('studentList');
            const title = document.getElementById('studentCardTitle');
            const sub = document.getElementById('studentCardSub');
            
            container.innerHTML = '';
            title.innerText = dept.department_name;
            sub.innerText = `Fee: â‚¹${dept.department_fees_amount.toLocaleString()}`;

            if (dept.unpaid_students.length === 0) {
                container.innerHTML = `<div class="text-center text-[#A3AED0] mt-10">No pending fees!</div>`;
                return;
            }

            dept.unpaid_students.forEach(s => {
                const pending = dept.department_fees_amount - s.amount;
                const el = document.createElement('div');
                el.className = 'flex items-center justify-between p-3 rounded-xl bg-[#F4F7FE]';
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-[#4318FF] text-white flex items-center justify-center text-xs font-bold">${s.name.charAt(0)}</div>
                        <div>
                            <p class="text-sm font-bold text-[#2B3674]">${s.name}</p>
                            <p class="text-xs text-[#A3AED0]">Due: â‚¹${s.amount.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="text-[#EE5D50] text-xs font-bold bg-white px-2 py-1 rounded-lg border border-[#EE5D50]/20">
                        â‚¹${pending.toLocaleString()} Pending
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // Initialize with default max unpaid
        const maxUnpaid = stackedBarData.reduce((prev, current) => (prev.unpaid_count > current.unpaid_count) ? prev : current);
        showStudentCard(maxUnpaid);

        // Click interaction on Stacked Bar
        deptChart.addEventListener('dataPointSelection', function(event, chartContext, config) {
            const deptIndex = config.dataPointIndex;
            showStudentCard(stackedBarData[deptIndex]);
        });

        /* --- MODAL LOGIC --- */
        const modal = document.getElementById('addStudentModal');
        const modalContent = modal.querySelector('div');
        const openModalBtn = document.getElementById('openModalBtn');
        const closeModalBtn = document.getElementById('closeAddStudentModal');
        const cancelModalBtn = document.getElementById('cancelAddStudentModal');

        function openModal() {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeModal() {
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        openModalBtn.addEventListener('click', openModal);
        closeModalBtn.addEventListener('click', closeModal);
        cancelModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // Form Validation & Submission Mock
        const form = document.getElementById('formAddStudent');
        const submitBtn = document.getElementById('formSubmitBtn');
        const inputs = form.querySelectorAll('input, select');
        
        function validateForm() {
            let valid = true;
            inputs.forEach(i => {
                if(i.hasAttribute('required') && !i.value) valid = false;
            });
            submitBtn.disabled = !valid;
        }
        inputs.forEach(i => i.addEventListener('input', validateForm));

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            // Mock AJAX request
            submitBtn.innerHTML = '<span class="material-icons animate-spin">refresh</span> Saving...';
            setTimeout(() => {
                closeModal();
                showToast('Student added successfully!', 'success');
                form.reset();
                submitBtn.innerHTML = 'Submit';
            }, 1500);
        });

        // Department Fee Logic
        const deptSelect = document.getElementById('department');
        const feeDisplay = document.getElementById('deptFeeDisplay');
        
        deptSelect.addEventListener('change', function() {
            const opt = this.options[this.selectedIndex];
            const fee = opt.getAttribute('data-fee');
            feeDisplay.textContent = fee ? `Department Fee: â‚¹${parseInt(fee).toLocaleString()}` : '';
            validateForm();
        });

    </script>
</body>
</html>
